{% extends 'base.html' %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    .chat-bg { background: linear-gradient(135deg,#9dceec,#d197d2,#481a58); flex: 1; padding: 30px; }
    .chatbox { max-width: 600px; margin: auto; background: #fff; border-radius: 30px; padding: 25px; height: 70vh; display: flex; flex-direction: column; }
    #message-area { flex: 1; overflow-y: auto; margin-bottom: 15px; padding: 10px; }
    .user { background: #ffdde1; padding: 10px; border-radius: 15px; margin: 5px 0 5px auto; max-width: 80%; }
    .bot { background: #c1f0f6; padding: 10px; border-radius: 15px; margin: 5px auto 5px 0; max-width: 80%; }
    input { width: 100%; padding: 12px; border-radius: 20px; border: 1px solid #ccc; outline: none; box-sizing: border-box; }
</style>
{% endblock %}

{% block content %}
<div class="chat-bg">
    <div class="chatbox">
        <h2 style="text-align: center; color: #d6336c;">ðŸ¤– Student AI Help</h2>
        <div id="message-area">
            <div class="bot">Hello! How can I help you today?</div>
        </div>
        <input type="text" id="user-input" placeholder="Type here..." onkeypress="if(event.key==='Enter') sendMessage()">
    </div>
</div>

<script>
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const area = document.getElementById('message-area');
        if (!input.value) return;

        area.innerHTML += `<div class="user">${input.value}</div>`;
        const botDiv = document.createElement('div');
        botDiv.className = 'bot';
        botDiv.innerText = 'Thinking...';
        area.appendChild(botDiv);
        
        const q = input.value;
        input.value = '';
        
        const res = await fetch(`/gemini-chat/?q=${encodeURIComponent(q)}`);
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        botDiv.innerHTML = '';

        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            botDiv.innerHTML += decoder.decode(value);
        }
        area.scrollTop = area.scrollHeight;
    }
</script>
{% endblock %}